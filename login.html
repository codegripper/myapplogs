<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOG In - MyappLogs</title>
    <meta name="description" content="Sign in to your MyappLogs account">
    <link rel="icon" type="image/x-icon" href="icons8-cabin-85.png">
    <link rel="stylesheet" href="css/login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>

<!-- login form -->
<div class="login-container">
    <div class="login-form">
        <h2>Welcome Back</h2>
        <form id="loginForm" novalidate>
            <div class="input-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="Enter your email" autocomplete="email" required>
            </div>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password" required>
            </div>

            <p id="error-code"></p>
            
            <div class="forgot-password">
                <a href="#" id="forgot-password-link">Forgot your password?</a>
            </div>

            <button type="submit" id="login" class="btn">Sign In</button>
        </form>

        <div class="divider">or continue with</div>

        <button type="button" id="handleGoogleSignIn" class="google-signin">
            <span class="google-icon"></span>
            Continue with Google
        </button>

        <div class="signup-link">
            <p>Don't have an account? <a href="#" id="signup-link">Create one</a></p>
        </div>
    </div>
</div>

<!-- Quick Reset Password Modal -->
<div id="resetModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <div class="modal-header">
            <h3>Reset Password</h3>
            <p>Enter your email to receive a reset link</p>
        </div>
        <div class="modal-input-group">
            <label for="modal-email">Email Address</label>
            <input type="email" id="modal-email" placeholder="Enter your email">
        </div>
        <div id="modal-message" class="modal-message"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancelReset">Cancel</button>
            <button class="modal-btn modal-btn-primary" id="sendReset">Send Reset Link</button>
        </div>
    </div>
</div>

<script type="module" src="./script/login.js"></script>
<script>
    // Handle signup navigation
    document.getElementById('signup-link').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/signup.html';
    });

    // Handle forgot password - show modal for quick reset
    document.getElementById('forgot-password-link').addEventListener('click', function(e) {
        e.preventDefault();
        // Show modal for quick reset
        document.getElementById('resetModal').classList.add('show');
        document.getElementById('modal-email').focus();
    });

    // Modal functionality
    const modal = document.getElementById('resetModal');
    const closeModal = document.getElementById('closeModal');
    const cancelReset = document.getElementById('cancelReset');
    
    function hideModal() {
        modal.classList.remove('show');
        document.getElementById('modal-email').value = '';
        document.getElementById('modal-message').classList.remove('show');
    }
    
    closeModal.addEventListener('click', hideModal);
    cancelReset.addEventListener('click', hideModal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            hideModal();
        }
    });
    
    // Handle quick reset
    document.getElementById('sendReset').addEventListener('click', async function() {
        const email = document.getElementById('modal-email').value.trim();
        const messageEl = document.getElementById('modal-message');
        
        if (!email) {
            messageEl.textContent = 'Please enter your email address';
            messageEl.className = 'modal-message error show';
            return;
        }
        
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            messageEl.textContent = 'Please enter a valid email address';
            messageEl.className = 'modal-message error show';
            return;
        }
        
        try {
            // Import sendPasswordResetEmail from the login.js module
            const { sendPasswordResetEmail, getAuth } = await import("../index.js");
            const auth = getAuth();
            
            this.textContent = 'Sending...';
            this.disabled = true;
            
            await sendPasswordResetEmail(auth, email);
            
            messageEl.textContent = `Reset link sent to ${email}. Check your inbox!`;
            messageEl.className = 'modal-message success show';
            
            setTimeout(() => {
                hideModal();
            }, 3000);
            
        } catch (error) {
            console.error('Reset error:', error);
            messageEl.textContent = 'Failed to send reset email. Please try again.';
            messageEl.className = 'modal-message error show';
        } finally {
            this.textContent = 'Send Reset Link';
            this.disabled = false;
        }
    });

    // Form submission handler
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // The login function from login.js will handle this
    });

    // Enhanced error display
    function showError(message) {
        const errorElement = document.getElementById('error-code');
        errorElement.textContent = message;
        errorElement.classList.add('show');
        setTimeout(() => {
            errorElement.classList.remove('show');
        }, 5000);
    }

    // Hide error when typing
    document.getElementById('email').addEventListener('input', function() {
        document.getElementById('error-code').classList.remove('show');
    });
    
    document.getElementById('password').addEventListener('input', function() {
        document.getElementById('error-code').classList.remove('show');
    });
</script>
</body>
</html>